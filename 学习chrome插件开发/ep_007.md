# 第七节：记忆的持久性（仅Manifest V3介绍）

在Manifest V3中，扩展的后台不再是持续运行的脚本，而是**Service Worker（服务工作线程）**。它会随时被暂停或重启，内存里的数据会丢失。所以要保存数据（比如点击计数），必须用浏览器的本地存储，还要处理好右键菜单这类“全局功能”（它们不会跟着Service Worker消失）。


## 一、V3的配置文件（manifest.json）

V3的配置文件和V2有明显区别，核心是指定Service Worker作为后台，同时申请必要的权限。

```json
{
  "name": "Test",          // 扩展名称
  "description": "Manifest V3 Test", // 扩展描述
  "version": "0.1.107",    // 扩展版本
  "permissions": ["contextMenus", "storage"], // 需申请的权限：右键菜单、本地存储
  "host_permissions": ["<all_urls>"], // 单独指定允许访问的网址（V3新规则）
  "background": {
    "service_worker": "background.js" // 后台用Service Worker，文件必须在根目录（不能放js子文件夹）
  },
  "manifest_version": 3    // 声明使用V3
}
```


## 二、V3的后台脚本（background.js）

因为Service Worker会重启，所以不能用变量存点击计数，必须用`chrome.storage.local`（本地存储）保存。同时要通过“事件监听”处理初始化、菜单创建和点击逻辑。

```javascript
// 1. 扩展安装时触发：只创建一次右键菜单（避免重复创建报错）
chrome.runtime.onInstalled.addListener(() => {
  chrome.contextMenus.create({
    id: "TestV3",          // 菜单唯一ID
    title: "V3 Test",      // 右键菜单显示的文字
    contexts: ["all"]      // 所有场景下都显示这个菜单（比如网页、图片上右键）
  });
});

// 2. 浏览器启动时触发：初始化计数为0（每个新浏览器会话重置一次）
chrome.runtime.onStartup.addListener(() => {
  chrome.storage.local.set({ clickCounter: 0 }, () => {
    console.log("V3 Test: 点击计数已初始化为0"); // 控制台提示初始化完成
  });
});

// 3. 右键菜单被点击时触发：更新计数并保存到本地存储
chrome.contextMenus.onClicked.addListener(() => {
  // 第一步：从本地存储获取当前计数
  chrome.storage.local.get("clickCounter", (result) => {
    // 第二步：计数加1
    result.clickCounter += 1;
    // 第三步：把新计数存回本地存储
    chrome.storage.local.set({ clickCounter: result.clickCounter }, () => {
      console.log(`V3 Test: 点击计数已更新为 ${result.clickCounter}`); // 控制台提示更新结果
    });
  });
});
```


## 三、操作步骤与注意事项

按以下步骤测试，能清楚看到V3的特性：

1. 打开Chrome的扩展页面（`chrome://extensions`），确保右上角“开发者模式”已开启。
2. 把`ep_007/v3`文件夹拖进扩展页面，完成安装。
3. 打开Service Worker管理页面（`chrome://serviceworker-internals`），找到刚才安装的扩展的Worker，点击“Inspect”（检查）。
4. 在弹出的检查窗口中，切换到“Console”（控制台）标签，能看到“点击计数已初始化为0”的提示。
5. 在`chrome://serviceworker-internals`页面上右键，选择“V3 Test”菜单，控制台会显示“点击计数已更新为1”。
6. 在`chrome://serviceworker-internals`页面，点击“Stop”暂停Service Worker，此时检查窗口会变黑（提示断开连接）。
7. 再右键选择“V3 Test”菜单，检查窗口会重新亮起，计数会继续增加（比如变成2）——说明本地存储没丢。
8. 回到扩展页面（`chrome://extensions`），刷新该扩展，检查窗口会变黑且不会自动恢复（因为旧的Service Worker已被替换）。
9. 重新在`chrome://serviceworker-internals`点击“Inspect”，右键选“V3 Test”，计数不会重置（因为刷新扩展不触发`onStartup`事件，本地存储还在）。
10. 重启Chrome后，重新检查控制台，会发现计数回到0（因为重启触发了`onStartup`事件，重新初始化）。


## 四、V3的关键结论

- 右键菜单是“全局的”，不会随Service Worker暂停/重启消失，所以只需在扩展安装时创建一次（用`onInstalled`）。
- 本地存储（`chrome.storage.local`）在扩展刷新时不会丢失，但浏览器重启时会被`onStartup`事件重置（按我们的代码逻辑）。
- 若需要统计“浏览器会话内的点击数”，必须用`onStartup`初始化，而不是靠Service Worker启动时初始化（因为它会反复重启）。
