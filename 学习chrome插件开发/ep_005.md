# 第五部分：上下文菜单（仅介绍V3版本）

我们来看看Manifest V3中如何实现上下文菜单。通过这个例子，我们可以进一步了解扩展中的消息传递机制。


## V3版本实现方式

在V3中，manifest配置和业务逻辑的写法与V2基本一致，但**后台脚本的实现有明显不同**。

因为V3使用的是“服务工作线程（service worker）”而非V2中持久运行的后台脚本，所以不能像V2那样在创建菜单时直接写内联的`onclick`处理函数。正确的做法是单独添加事件监听器。

具体代码如下：

```javascript
// 清除、创建并监听新的上下文菜单
const handleContextMenus = () => {
  // 先移除已有的所有菜单项
  chrome.contextMenus.removeAll();

  // 创建新菜单
  chrome.contextMenus.create({
    title: "V3 Test",  // 菜单显示的文字
    id: "TestV3",      // 菜单唯一标识
    contexts: ["all"]  // 表示在任何内容上右键都显示这个菜单
    // 注意：因为用了服务工作线程，不能在这里直接写onclick处理逻辑
  });

  // 单独添加点击事件监听器，处理菜单点击
  chrome.contextMenus.onClicked.addListener(menu => {
    // 获取当前激活的标签页
    chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
      // 向当前标签页发送消息
      chrome.tabs.sendMessage(tabs[0].id, {
        msg: "Greetings from your Test V3 context menu"
      });
    });
  });
};
```


## 安装与查看效果

1. **安装扩展**：把包含V3版本代码的文件夹（比如`ep_005/v3/`）拖进Chrome的`chrome://extensions`页面。  
   - 安装后，V3扩展可能会显示关于Manifest V3的警告，属于正常现象。

2. **调试检查**：  
   - 要查看V3的后台脚本日志，需要打开`chrome://serviceworker-internals`页面，找到对应的服务工作线程，点击“Inspect”进入调试面板。


## 实际效果

1. 打开一个新标签页，右键点击页面任意位置，会看到名为“V3 Test”的上下文菜单项。  
2. 点击这个菜单项后，在页面的控制台（按F12打开）会看到收到的消息：  
   ```
   {msg: "Greetings from your Test V3 context menu"}
   ```


## 注意点

V3中由于使用服务工作线程，不能再用V2那种“内联事件处理”的写法（比如直接在`chrome.contextMenus.create`里写`onclick`），必须通过`addListener`单独绑定事件。这是迁移到V3时需要特别注意的地方。