# Manifest V3 介绍

## 从V2迁移到V3的第一个问题
如果把V2的配置直接复制到V3目录，只改`manifest_version`为3，会弹出错误：
```
Failed to load extension
File ~/ep_004/v3/
Error The "background.scripts" key cannot be used with manifest_version 3. Use the "background.service_worker" key instead.
Could not load manifest.
```
这说明V3不再支持`background.scripts`，必须改用`background.service_worker`。


## V3的配置示例
正确的V3配置应该像这样：
```json
{
  "version": "0.0.104",
  "name": "Test",
  "description": "Manifest V3 Test",
  "background": {
    "service_worker": "js/background.js"  // 注意这里是字符串，不是数组
  },
  "permissions": ["tabs"],
  "host_permissions": ["*://*/*"],  // V3中主机权限单独列出
  "content_scripts": [
    {
      "js": ["js/content.js"],
      "matches": ["*://*/*"]
    }
  ],
  "manifest_version": 3
}
```


## 遇到的问题
配置好后加载扩展，会发现两个问题：
1. 在`chrome://extensions`里看不到可检查的背景视图
2. 页面控制台只显示`content.js`的消息（"Content script has loaded via Manifest V3"），没有其他内容，像是背景脚本没执行


## 原因分析
根据文档，V3对背景脚本有明确要求：
- 必须用`background.service_worker`替代`background.page`或`background.scripts`，且值是字符串（不是数组）
- 要移除`background.persistent`（如果之前用过的话）
- 背景脚本需要适应服务工作线程（service worker）的执行环境


## 解决过程中的发现
经过调试，发现关键问题：
- 服务工作线程**不能放在扩展的子目录**（比如`js/background.js`），必须放在扩展的根目录（比如`background.js`才会生效）
- 错误日志显示：`The path of the provided scope ('/') is not under the max scope allowed ('/js/')`，印证了路径问题


## 如何调试V3的背景服务工作线程
1. 打开`chrome://serviceworker-internals`，勾选"Open Devtools and Pause JavaScript"
2. 打开`chrome://inspect/#service-workers`
3. 重新加载扩展，会弹出`background.js`的调试窗口
4. 在`chrome://serviceworker-internals`里能看到服务工作线程的状态和日志，帮助排查问题


## 总结的要点
1. **路径限制**：V3的背景服务工作线程必须放在扩展根目录，不能在子文件夹（如`js/`）
2. **调试方法**：通过`chrome://serviceworker-internals`和`chrome://inspect/#service-workers`检查服务工作线程
3. **配置变化**：用`background.service_worker`（字符串）替代`background.scripts`（数组），主机权限移到`host_permissions`

只要注意这些点，V3的背景服务工作线程就能正常运行。